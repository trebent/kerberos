services:
  kerberos:
    image: "ghcr.io/trebent/kerberos:${VERSION}"
    pull_policy: if_not_present
    build:
      context: ../..
      dockerfile: ./Dockerfile
    ports:
      - ${KERBEROS_PORT}:${KERBEROS_PORT}
      - ${KERBEROS_METRICS_PORT}:${KERBEROS_METRICS_PORT}
    environment:
      - OTEL_METRICS_EXPORTER=prometheus
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_PROMETHEUS_HOST=kerberos
      - OTEL_EXPORTER_PROMETHEUS_PORT=${KERBEROS_METRICS_PORT}
      - LOG_TO_CONSOLE=1
      - LOG_VERBOSITY=20
      - PORT=${KERBEROS_PORT}
      - VERSION=${VERSION}
      - ROUTE_JSON_FILE=/echo.json
      - AUTH_JSON_FILE=/auth.json
    volumes:
      - ../config/router-integration.json:/echo.json
      - ../config/auth-integration.json:/auth.json
  
  echo:
    image: "ghcr.io/trebent/kerberos/echo:${VERSION}"
    pull_policy: if_not_present
    build:
      context: ../..
      dockerfile: ./cmd/echo/Dockerfile
    ports:
      - ${ECHO_PORT}:${ECHO_PORT}
      - ${ECHO_METRICS_PORT}:${ECHO_METRICS_PORT}
    environment:
      - PORT=${ECHO_PORT}
      - OTEL_METRICS_EXPORTER=prometheus
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_EXPORTER_OTLP_TRACES_PROTOCOL=grpc
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_PROMETHEUS_HOST=echo
      - OTEL_EXPORTER_PROMETHEUS_PORT=${ECHO_METRICS_PORT}

  protected-echo:
    image: "ghcr.io/trebent/kerberos/echo:${VERSION}"
    pull_policy: if_not_present
    build:
      context: ../..
      dockerfile: ./cmd/echo/Dockerfile
    environment:
      - PORT=${ECHO_PORT}
      - OTEL_METRICS_EXPORTER=prometheus
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_EXPORTER_OTLP_TRACES_PROTOCOL=grpc
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_PROMETHEUS_HOST=protected-echo
      - OTEL_EXPORTER_PROMETHEUS_PORT=${ECHO_METRICS_PORT}

  prometheus:
    image: "prom/prometheus:v3.3.1"
    pull_policy: if_not_present
    ports:
      - ${PROM_PORT}:9090
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: "grafana/grafana:12.0.0"
    pull_policy: if_not_present
    ports:
      - ${GRAFANA_PORT}:3000
    volumes:
      - ./grafana/grafana-datasources.yml:/etc/grafana/provisioning/datasources/grafana-datasources.yml
      - ./grafana/grafana-dashboards.yml:/etc/grafana/provisioning/dashboards/grafana-dashboards.yml
      - ./grafana/prometheus.json:/var/lib/grafana/prometheus.json
      - ./grafana/kerberos_runtime.json:/var/lib/grafana/kerberos_runtime.json
      - ./grafana/kerberos_http.json:/var/lib/grafana/kerberos_http.json
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini

  jaeger:
    image: "jaegertracing/jaeger:2.6.0"
    pull_policy: if_not_present
    ports:
      - 4317:4317
      - 16685:16685
      - 16686:16686
    environment:
      - COLLECTOR_OTLP_ENABLED=true